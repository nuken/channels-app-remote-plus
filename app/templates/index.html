<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Channels Remote Plus</title>
	<link rel="manifest" href="/static/manifest.json">
    <style>
        /* Base CSS Variables (Default Light Theme) */
        :root {
            --body-bg-color: #f4f4f4;
            --text-color: #333;
            --container-bg-color: #fff;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --header-color: #0056b3;
            --config-info-bg: #e9ecef;

            --button-bg-color: #007bff;
            --button-hover-bg-color: #0056b3;
            --button-active-bg-color: #004085;
            --button-text-color: white;

            --input-border-color: #ccc;
            --pre-bg-color: #e9ecef;
            --pre-border-color: #dee2e6;

            --notification-success-bg: #4CAF50;
            --notification-error-bg: #f44336;

            --now-playing-bg: #e9ecef;
            --now-playing-border: #dee2e2;
            --now-playing-header-color: #0056b3;
            --now-playing-text-color: #333;
            --now-playing-episode-color: #666;
            --now-playing-summary-color: #555;
            --now-playing-image-shadow: 0 2px 5px rgba(0,0,0,0.1);

            --recording-card-bg: #f8f9fa;
            --recording-card-border: #e0e0e0;
            --recording-title-color: #007bff;
            --recording-episode-color: #6c757d;
            --recording-summary-color: #495057;
        }

        /* Dark Theme 1: Default Dark with Gray Buttons */
        body.theme-dark-gray {
            --body-bg-color: #2c2c2c;
            --text-color: #e0e0e0;
            --container-bg-color: #3a3a3a;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            --header-color: #7dd3fc; /* Light blue for headers */
            --config-info-bg: #4a4a4a;

            --button-bg-color: #555555;
            --button-hover-bg-color: #666666;
            --button-active-bg-color: #444444;
            --button-text-color: #ffffff;

            --input-border-color: #666;
            --pre-bg-color: #4a4a4a;
            --pre-border-color: #5a5a5a;

            --notification-success-bg: #28a745;
            --notification-error-bg: #dc3545;

            --now-playing-bg: #4a4a4a;
            --now-playing-border: #5a5a5a;
            --now-playing-header-color: #7dd3fc;
            --now-playing-text-color: #e0e0e0;
            --now-playing-episode-color: #b0b0b0;
            --now-playing-summary-color: #c0c0c0;

            --recording-card-bg: #4a4a4a;
            --recording-card-border: #5a5a5a;
            --recording-title-color: #7dd3fc;
            --recording-episode-color: #b0b0b0;
            --recording-summary-color: #c0c0c0;
        }

        /* Dark Theme 2: Dark with Green Buttons */
        body.theme-dark-green {
            --body-bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --container-bg-color: #2b2b2b;
            --box-shadow: 0 2px 15px rgba(0,0,0,0.4);
            --header-color: #a7f3d0; /* Light green for headers */
            --config-info-bg: #3c3c3c;

            --button-bg-color: #28a745; /* Green */
            --button-hover-bg-color: #218838;
            --button-active-bg-color: #1e7e34;
            --button-text-color: #ffffff;

            --input-border-color: #555;
            --pre-bg-color: #3c3c3c;
            --pre-border-color: #4c4c4c;

            --notification-success-bg: #28a745;
            --notification-error-bg: #dc3545;

            --now-playing-bg: #3c3c3c;
            --now-playing-border: #4c4c4c;
            --now-playing-header-color: #a7f3d0;
            --now-playing-text-color: #e0e0e0;
            --now-playing-episode-color: #b0b0b0;
            --now-playing-summary-color: #c0c0c0;

            --recording-card-bg: #3c3c3c;
            --recording-card-border: #4c4c4c;
            --recording-title-color: #a7f3d0;
            --recording-episode-color: #b0b0b0;
            --recording-summary-color: #c0c0c0;
        }

        /* Light Theme 2: Light with Purple Buttons */
        body.theme-light-purple {
            --body-bg-color: #f0f2f5;
            --text-color: #333;
            --container-bg-color: #ffffff;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --header-color: #6f42c1; /* Purple for headers */
            --config-info-bg: #e6eaf0;

            --button-bg-color: #6f42c1; /* Purple */
            --button-hover-bg-color: #5c37a7;
            --button-active-bg-color: #4b2e8a;
            --button-text-color: white;

            --input-border-color: #d1d4d8;
            --pre-bg-color: #e6eaf0;
            --pre-border-color: #d1d4d8;

            --notification-success-bg: #28a745;
            --notification-error-bg: #dc3545;

            --now-playing-bg: #e6eaf0;
            --now-playing-border: #d1d4d8;
            --now-playing-header-color: #6f42c1;
            --now-playing-text-color: #333;
            --now-playing-episode-color: #666;
            --now-playing-summary-color: #555;

            --recording-card-bg: #f0f2f5;
            --recording-card-border: #d1d4d8;
            --recording-title-color: #6f42c1;
            --recording-episode-color: #666;
            --recording-summary-color: #555;
        }


        /* General Styles using CSS Variables */
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: var(--body-bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--container-bg-color);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--box-shadow);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        h1, h2 {
            color: var(--header-color);
            transition: color 0.3s ease;
        }
        .config-info {
            background-color: var(--config-info-bg);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(135px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 12px 15px;
            font-size: 1em;
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            white-space: nowrap;
        }
        button:hover { background-color: var(--button-hover-bg-color); }
        button:active { background-color: var(--button-active-bg-color); }
        button:disabled { background-color: #cccccc; cursor: not-allowed; color: #666; }

        .input-group { margin-top: 15px; display: flex; gap: 10px; align-items: center; }
        .input-group input {
            padding: 10px;
            font-size: 1em;
            border: 1px solid var(--input-border-color);
            border-radius: 5px;
            flex-grow: 1;
            background-color: var(--container-bg-color); /* Match container bg */
            color: var(--text-color);
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }

        #seek_amount_input {
            width: 70px;
            text-align: center;
            -moz-appearance: textfield;
            flex-grow: 0;
        }
        #seek_amount_input::-webkit-outer-spin-button,
        #seek_amount_input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #manual_channel_input {
            min-width: 120px;
        }

        pre {
            background-color: var(--pre-bg-color);
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--pre-border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .status-section { margin-top: 25px; }
        .channel-list-section { margin-top: 25px; }
        .channel-list-section select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--input-border-color);
            font-size: 1em;
            margin-bottom: 10px;
            background-color: var(--container-bg-color); /* Match container bg */
            color: var(--text-color);
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        .channel-list-section .refresh-button-container { text-align: right; margin-top: 5px; }
        .seek-controls { margin-top: 15px; }

        /* Notification Styling */
        #notification-area {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }
        .notification {
            background-color: var(--notification-success-bg);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, background-color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 0.9em;
        }
        .notification.error { background-color: var(--notification-error-bg); }
        .notification.show { opacity: 1; }

        /* Styling for Now Playing display */
        #now-playing-display {
            display: flex;
            align-items: flex-start;
            background-color: var(--now-playing-bg);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid var(--now-playing-border);
            margin-top: 10px;
            gap: 15px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #now-playing-display img {
            max-width: 120px;
            height: auto;
            border-radius: 4px;
            box-shadow: var(--now-playing-image-shadow);
            flex-shrink: 0;
        }
        #now-playing-info {
            flex-grow: 1;
        }
        #now-playing-info h3 {
            margin-top: 0;
            margin-bottom: 5px;
            color: var(--now-playing-header-color);
            font-size: 1.2em;
            transition: color 0.3s ease;
        }
        #now-playing-info p {
            margin: 0;
            font-size: 0.95em;
            color: var(--now-playing-text-color);
            transition: color 0.3s ease;
        }
        #now-playing-info .episode-details {
            font-size: 0.85em;
            color: var(--now-playing-episode-color);
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
        #now-playing-info .summary {
            font-size: 0.85em;
            color: var(--now-playing-summary-color);
            transition: color 0.3s ease;
        }
        #now-playing-display.hidden {
            display: none;
        }

        /* New styles for DVR movies and shows section */
        #movies-list-section, #shows-list-section {
            margin-top: 25px;
        }

        /* Wrapper for horizontal scrolling + arrows */
        .carousel-wrapper {
            position: relative; /* For positioning arrows */
            margin-top: 15px;
            /* Ensure the wrapper doesn't expand beyond its parent visually */
            max-width: 100%;
            overflow: hidden; /* Hide arrows that are outside the bounds of the wrapper */
        }

        /* MODIFIED for Horizontal Scrolling */
        #movies-list, #episodes-list {
            display: flex; /* Change from grid to flex */
            flex-wrap: nowrap; /* Prevent wrapping */
            overflow-x: auto; /* Enable horizontal scrolling */
            overflow-y: hidden; /* Hide vertical scrollbar */
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
            gap: 20px; /* Spacing between cards */
            padding-bottom: 20px; /* Add some padding at the bottom for scrollbar visibility if not hidden */
            padding-left: 10px; /* Padding for the start of the list within wrapper */
            padding-right: 10px; /* Padding for the end of the list within wrapper */


            /* Optional: For a smoother "snap" effect like a real carousel */
            scroll-snap-type: x mandatory; /* Snap points along the x-axis */
            scroll-padding-left: 10px; /* Padding for the snapping area at the start */


            /* Optional: Hide scrollbar for a cleaner look */
            scrollbar-width: none; /* For Firefox */
            -ms-overflow-style: none;  /* For Internet Explorer and Edge */
        }

        /* Hide scrollbar for WebKit browsers (Chrome, Safari) */
        #movies-list::-webkit-scrollbar,
        #episodes-list::-webkit-scrollbar {
            display: none;
        }

        .movie-card, .episode-card {
            background-color: var(--recording-card-bg);
            border: 1px solid var(--recording-card-border);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;

            /* MODIFIED for Horizontal Scrolling */
            flex-shrink: 0; /* Prevents cards from shrinking */
            width: 280px; /* Fixed width for cards */
            scroll-snap-align: start; /* Align card to snap point */
        }

        .movie-card:hover, .episode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .movie-card-image-container, .episode-card-image-container {
            width: 100%;
            height: 160px; /* Fixed height for image area */
            background-color: #333; /* Placeholder background */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .movie-card-image-container img, .episode-card-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Cover the area, crop if necessary */
            display: block;
            transition: opacity 0.3s ease;
        }

        .movie-card-image-container img.error-img, .episode-card-image-container img.error-img {
            display: none; /* Hide if error occurs */
        }

        .movie-card-image-container .no-image-text, .episode-card-image-container .no-image-text {
            color: #fff;
            font-size: 0.9em;
            text-align: center;
            padding: 10px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .movie-card-content, .episode-card-content {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .movie-card-content h3, .episode-card-content h3 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 1.1em;
            color: var(--recording-title-color);
            transition: color 0.3s ease;
        }

        .movie-card-content .episode-details, .episode-card-content .episode-details {
            font-size: 0.85em;
            color: var(--recording-episode-color);
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }

        .movie-card-content .summary, .episode-card-content .summary {
            font-size: 0.8em;
            color: var(--recording-summary-color);
            margin-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limit to 3 lines */
            -webkit-box-orient: vertical;
            transition: color 0.3s ease;
        }

        .movie-card-content .play-button-container, .episode-card-content .play-button-container {
            margin-top: auto; /* Push button to the bottom */
            text-align: center;
        }

        .movie-card-content .play-button, .episode-card-content .play-button {
            padding: 8px 15px;
            font-size: 0.9em;
            width: 100%;
        }

        #movies-list.loading::after, #episodes-list.loading::after {
            content: "Loading...";
            display: block;
            width: 100%;
            text-align: center;
            margin-top: 20px;
            color: var(--text-color);
        }

        #movies-list.loading .movie-card, #episodes-list.loading .episode-card {
            opacity: 0.5; /* Dim cards while loading */
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .section-header h2 {
            margin: 0;
            padding: 0;
        }

        .section-toggle-button {
            padding: 8px 12px;
            font-size: 0.85em;
            background-color: #6c757d; /* A neutral gray */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .section-toggle-button:hover {
            background-color: #5a6268;
        }

        /* Scroll Arrows Styling */
        .scroll-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
            color: white;
            border: none;
            border-radius: 50%; /* Make them round */
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            z-index: 10; /* Ensure they are above content */
            opacity: 0.8;
            transition: opacity 0.3s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none; /* Prevent text selection */
            -webkit-user-select: none;
        }

        .scroll-arrow:hover {
            opacity: 1;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .scroll-arrow.left {
            left: 5px; /* Adjust as needed */
        }

        .scroll-arrow.right {
            right: 5px; /* Adjust as needed */
        }

        .scroll-arrow.hidden {
            display: none;
        }


        /* Media queries */
        @media (max-width: 600px) {
            .movie-card, .episode-card {
                /* Make cards take up more width on smaller screens, accounting for container margins/padding */
                width: calc(100vw - 40px); /* Example: 100vw - (2 * 20px body margin) */
            }
            /* On mobile, arrows might be always visible or have different opacity */
            .scroll-arrow {
                opacity: 0.8;
                /* If you want them always visible without hover: */
                /* display: flex !important; */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Channels App Remote Plus</h1>

        <div style="margin-bottom: 20px;">
            <label for="theme-select" style="margin-right: 10px;">Select Theme:</label>
            <select id="theme-select" onchange="applyTheme()">
                <option value="default-light">Default Light</option>
                <option value="light-purple">Light (Purple Buttons)</option>
                <option value="dark-gray">Dark (Gray Buttons)</option>
                <option value="dark-green">Dark (Green Buttons)</option>
            </select>
        </div>

        <div class="config-info">
            <p><strong>Configured Clients:</strong></p>
            <select id="client-select" onchange="selectClient()">
                <option value="">Select a Client</option>
                {% for client in clients %}
                   <option value="{{ client.ip }}">{{ client.name }} ({{ client.ip }})</option>
                {% endfor %}
            </select>
            {% if not clients_configured %}
                <p style="color: red;">No clients configured. Set CHANNELS_APP_CLIENTS environment variable.</p>
            {% endif %}
            <p style="font-size: 0.8em; margin-top: 10px;">
                <strong>Select Channels DVR Server:</strong><br>
                <select id="dvr-server-select" onchange="selectDvrServer()">
                    <option value="">Select a DVR Server</option>
                    {% for server in dvr_servers %}
                        <option value="{{ server.ip }}">{{ server.name }} ({{ server.ip }})</option>
                    {% endfor %}
                </select>
                {% if not dvr_servers_configured %}
                    <p style="color: red;">No DVR servers configured. Set CHANNELS_DVR_SERVERS environment variable.</p>
                {% endif %}
               <div id="dvr-server-ip-display" style="display: none;"></div></p>
        </div>

        <div style="margin-bottom: 20px;">
            <input type="checkbox" id="enablePopups" checked>
            <label for="enablePopups">Show Status Notifications (Recommended: Off for mobile)</label>
        </div>


        <h2>Playback Controls</h2>
        <div class="button-grid">
            <button class="control-button" onclick="sendCommand('toggle_pause')">Play/Pause</button>
            <button class="control-button" onclick="sendCommand('stop')">Stop</button>
            <button class="control-button" onclick="sendCommand('toggle_mute')">Mute</button>
            <button class="control-button" onclick="sendCommand('toggle_cc')">CC</button>
            <button class="control-button" onclick="toggleCcAndMute()">CC/Mute</button>
            <button class="control-button" onclick="rewindAndEnableCC()">Back 15/CC</button>
            <button class="control-button" onclick="sendCommand('channel_up')">Ch Up</button>
            <button class="control-button" onclick="sendCommand('channel_down')">Ch Down</button>
            <button class="control-button" onclick="sendCommand('previous_channel')">Previous Ch</button>
        </div>

        <div class="seek-controls input-group">
            <input type="number" id="seek_amount_input" value="30" placeholder="Secs"> <button class="control-button" onclick="sendSeekCommand(-1 * document.getElementById('seek_amount_input').value)">Go Back</button>
            <button class="control-button" onclick="sendSeekCommand(document.getElementById('seek_amount_input').value)">Go Forward</button>
        </div>

        <div class="input-group">
            <input type="number" id="manual_channel_input" placeholder="Enter Channel #"> <button class="control-button" onclick="sendCommand('play_channel', document.getElementById('manual_channel_input').value)">Go</button>
        </div>

        <div class="channel-list-section">
            <h2>Live TV Favorite Channels</h2>
            <select id="channel-select" class="control-button" onchange="tuneToSelectedChannel()">
                <option value="">Select a Channel</option>
                </select>
            <div class="refresh-button-container">
                <button class="control-button" onclick="loadChannels()">Refresh Favorites</button>
            </div>
            <p style="font-size: 0.8em; margin-top: 5px;">Fetches favorite channels directly from the selected Channels App client.</p>
        </div>


        <h2>Navigation</h2>
        <div class="button-grid">
            <button class="control-button" onclick="sendCommand('navigate', 'Live TV')">Go to Live TV</button>
            <button class="control-button" onclick="sendCommand('navigate', 'Guide')">Go to Guide</button>
            <button class="control-button" onclick="sendCommand('navigate', 'Library')">Go to Library</button>
            <button class="control-button" onclick="sendCommand('navigate', 'Search')">Go to Search</button>
        </div>

        <div id="movies-list-section">
            <div class="section-header">
                <h2>Movies</h2>
                <button class="section-toggle-button" onclick="toggleSection('movies-carousel-wrapper', this)">Hide Content</button>
            </div>
            <button class="control-button" onclick="loadMovies()">Load Movies</button>
            <p style="font-size: 0.8em; margin-top: 5px;">Fetches movies from your Channels DVR Server.</p>
            <div id="movies-carousel-wrapper" class="carousel-wrapper">
                <button class="scroll-arrow left" onmousedown="startAutoScroll(document.getElementById('movies-list'), -1)" onmouseup="stopAutoScroll()" onmouseleave="stopAutoScroll()" ontouchstart="startAutoScroll(document.getElementById('movies-list'), -1)" ontouchend="stopAutoScroll()" ontouchcancel="stopAutoScroll()">&#9664;</button>
<div id="movies-list">
</div>
<button class="scroll-arrow right" onmousedown="startAutoScroll(document.getElementById('movies-list'), 1)" onmouseup="stopAutoScroll()" onmouseleave="stopAutoScroll()" ontouchstart="startAutoScroll(document.getElementById('movies-list'), 1)" ontouchend="stopAutoScroll()" ontouchcancel="stopAutoScroll()">&#9654;</button>
            </div>
        </div>

        <div id="shows-list-section">
            <div class="section-header">
                <h2>TV Shows (Recent Episodes)</h2>
                <button class="section-toggle-button" onclick="toggleSection('episodes-carousel-wrapper', this)">Hide Content</button>
            </div>
            <button class="control-button" onclick="loadShows()">Load Recent Episodes</button>
            <p style="font-size: 0.8em; margin-top: 5px;">Fetches recent TV show episodes from your Channels DVR Server.</p>
            <div id="episodes-carousel-wrapper" class="carousel-wrapper">
                <button class="scroll-arrow left" onmousedown="startAutoScroll(document.getElementById('episodes-list'), -1)" onmouseup="stopAutoScroll()" onmouseleave="stopAutoScroll()" ontouchstart="startAutoScroll(document.getElementById('episodes-list'), -1)" ontouchend="stopAutoScroll()" ontouchcancel="stopAutoScroll()">&#9664;</button>
<div id="episodes-list">
</div>
<button class="scroll-arrow right" onmousedown="startAutoScroll(document.getElementById('episodes-list'), 1)" onmouseup="stopAutoScroll()" onmouseleave="stopAutoScroll()" ontouchstart="startAutoScroll(document.getElementById('episodes-list'), 1)" ontouchend="stopAutoScroll()" ontouchcancel="stopAutoScroll()">&#9654;</button>
            </div>
        </div>

        <div class="status-section">
            <h2>Current Device Status</h2>
            <button class="control-button" onclick="getStatus()">Refresh Status</button>
            <div id="now-playing-display" class="hidden">
                </div>
            <pre id="status-display" style="margin-top: 10px;"></pre>
        </div>
    </div>

    <div id="notification-area"></div>

    <script>
        const clientSelect = document.getElementById('client-select');
        const dvrServerSelect = document.getElementById('dvr-server-select'); // New element
        const channelSelect = document.getElementById('channel-select');
        const enablePopupsCheckbox = document.getElementById('enablePopups');
        const notificationArea = document.getElementById('notification-area');
        const statusDisplay = document.getElementById('status-display');
        const nowPlayingDisplay = document.getElementById('now-playing-display');
        const controlButtons = document.querySelectorAll('.control-button');
        const themeSelect = document.getElementById('theme-select');
        const dvrServerIpDisplay = document.getElementById('dvr-server-ip-display');
        const moviesListDiv = document.getElementById('movies-list');
        const episodesListDiv = document.getElementById('episodes-list');

        let selectedClientIp = '';
        let selectedDvrServerIp = ''; // New variable
        let autoScrollInterval; // Variable to hold the interval ID

        const flaskClients = {{ clients | tojson }};
        const clientsConfiguredViaEnv = {{ clients_configured | tojson }};
        const flaskDvrServers = {{ dvr_servers | tojson }}; // New from Flask
        const dvrServersConfiguredViaEnv = {{ dvr_servers_configured | tojson }};


        function showNotification(message, isError = false) {
            if (!enablePopupsCheckbox.checked) {
                console.log("Notification suppressed:", message);
                return;
            }
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : ''}`;
            notification.textContent = message;
            notificationArea.appendChild(notification);

            void notification.offsetWidth; // Trigger reflow for CSS transition
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove(), { once: true });
            }, 3000);
        }

        function toggleControls(enable) {
            controlButtons.forEach(button => {
                button.disabled = !enable;
            });
            if (enable && selectedClientIp) {
                channelSelect.disabled = false;
            } else {
                channelSelect.disabled = true;
            }
        }

        function applyTheme() {
            const selectedTheme = themeSelect.value;
            document.body.className = ''; // Remove existing theme classes
            if (selectedTheme !== 'default-light') {
                document.body.classList.add(`theme-${selectedTheme}`);
            }
            localStorage.setItem('selectedTheme', selectedTheme); // Save preference
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Load and apply saved theme
            const savedTheme = localStorage.getItem('selectedTheme') || 'default-light';
            themeSelect.value = savedTheme; // Set dropdown to saved value
            applyTheme(); // Apply the theme

            const savedPopupState = localStorage.getItem('enablePopups');
            if (savedPopupState !== null) {
                enablePopupsCheckbox.checked = JSON.parse(savedPopupState);
            } else {
                enablePopupsCheckbox.checked = false; // Default to off for better mobile experience
            }

            enablePopupsCheckbox.addEventListener('change', () => {
                localStorage.setItem('enablePopups', enablePopupsCheckbox.checked);
            });

            if (flaskClients.length > 0) {
                clientSelect.selectedIndex = 1; // Auto-select first client
                await selectClient(); // Use await to ensure client is selected before further actions
            } else {
                toggleControls(false);
                statusDisplay.innerText = "No Channels App clients configured. Please set CHANNELS_APP_CLIENTS environment variable.";
                nowPlayingDisplay.classList.add('hidden');
                showNotification("No Channels App clients configured.", true);
            }

            // Auto-select first DVR server if available
            if (flaskDvrServers.length > 0) {
                dvrServerSelect.selectedIndex = 1;
                selectDvrServer(); // Select the first DVR server
            } else {
                dvrServerSelect.disabled = true;
                showNotification("No DVR servers configured.", true);
            }

            setupCarouselNavigation(); // Setup carousel navigation after DOM content is loaded
        });

        async function selectClient() {
            selectedClientIp = clientSelect.value;
            if (selectedClientIp) {
                showNotification(`Controlling: ${clientSelect.options[clientSelect.selectedIndex].text}`, false);
                toggleControls(true);
                getStatus();
                loadChannels();
            } else {
                showNotification("Please select a client device.", true);
                toggleControls(false);
                statusDisplay.innerText = "Select a client and click \"Refresh Status\" to fetch.";
                nowPlayingDisplay.classList.add('hidden');
                channelSelect.innerHTML = '<option value="">Select a Client First</option>';
            }
        }

        function selectDvrServer() {
            selectedDvrServerIp = dvrServerSelect.value;
            if (selectedDvrServerIp) {
                dvrServerIpDisplay.textContent = `Selected: ${dvrServerSelect.options[dvrServerSelect.selectedIndex].text}`;
                dvrServerIpDisplay.style.display = 'inline'; // Show the selected IP
                showNotification(``, false);
                // Optionally auto-load movies/shows here, or leave to user's button clicks
                loadMovies();
                loadShows();
            } else {
                dvrServerIpDisplay.textContent = 'Not Selected';
                dvrServerIpDisplay.style.display = 'none'; // Hide if no server selected
                moviesListDiv.innerHTML = '<p>Please select a DVR server.</p>';
                episodesListDiv.innerHTML = '<p>Please select a DVR server.</p>';
                showNotification("Please select a DVR server.", true);
            }
        }

        async function sendCommand(action, value = null, recordingId = null) {
            if (!selectedClientIp) {
                showNotification("Please select a Channels App client first.", true);
                return 'error';
            }

            const data = { action: action, device_ip: selectedClientIp };
            if (value !== null) {
                data.value = value;
            }
            if (recordingId !== null) {
                data.recording_id = recordingId; // Send as recording_id to backend
            }

            try {
                const response = await fetch('/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showNotification(`Action '${action}': ${result.message}`, result.status === 'error');
                getStatus(); // Refresh status after any command
                return result.status;
            } catch (error) {
                showNotification(`Error sending command: ${error.message}`, true);
                return 'error';
            }
        }

        async function sendSeekCommand(amount) {
            if (!selectedClientIp) {
                showNotification("Please select a client device first.", true);
                return 'error';
            }
            const seekValue = parseInt(amount, 10);
            if (isNaN(seekValue)) {
                showNotification("Please enter a valid number for seek amount.", true);
                return 'error';
            }

            const data = { action: 'seek', device_ip: selectedClientIp, seek_amount: seekValue };

            try {
                const response = await fetch('/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showNotification(`Seek ${seekValue}s: ${result.message}`, result.status === 'error');
                getStatus();
                return result.status;
            } catch (error) {
                showNotification(`Error sending seek command: ${error.message}`, true);
                return 'error';
            }
        }

        async function toggleCcAndMute() {
            if (!selectedClientIp) {
                showNotification("Please select a client device first.", true);
                return;
            }

            const ccStatus = await sendCommand('toggle_cc');
            if (ccStatus === 'error') {
                showNotification("Failed to toggle Closed Captions.", true);
                return;
            }

            const muteStatus = await sendCommand('toggle_mute');
            if (muteStatus === 'error') {
                showNotification("Failed to toggle Mute.", true);
                return;
            }

            if (ccStatus === 'success' && muteStatus === 'success') {
                showNotification("Closed Captions and Mute toggled successfully.", false);
            }
        }

        async function rewindAndEnableCC() {
            if (!selectedClientIp) {
                showNotification("Please select a client device first.", true);
                return;
            }

            const seekStatus = await sendSeekCommand(-15);
            if (seekStatus === 'error') {
                showNotification("Failed to rewind.", true);
                return;
            }

            const ccToggleStatus = await sendCommand('toggle_cc');
            if (ccToggleStatus === 'success') {
                showNotification("Rewound 15s and Closed Captions toggled.", false);
            } else {
                showNotification("Rewound 15s, but failed to toggle Closed Captions.", true);
            }
        }

        async function getStatus() {
            if (!selectedClientIp) {
                statusDisplay.innerText = "No client selected.";
                nowPlayingDisplay.classList.add('hidden');
                return;
            }
            try {
                const response = await fetch(`/status?device_ip=${selectedClientIp}`);
                const status = await response.json();

                statusDisplay.innerText = JSON.stringify(status, null, 2);
                statusDisplay.style.display = 'block';

                if (status.status === 'error') {
                    showNotification(`Status Error: ${status.message}`, true);
                    nowPlayingDisplay.classList.add('hidden');
                } else {
                    showNotification(`Status refreshed for ${selectedClientIp}.`, false);

                    const np = status.now_playing; // Shorter variable for convenience

                    // Check if now_playing data is available and meaningful
                    if (np && np.title) {
                        let episodeDetails = '';
                        if (np.season_number && np.episode_number) {
                            episodeDetails += `S${np.season_number} E${np.episode_number}`;
                            if (np.episode_title) {
                                episodeDetails += `: ${np.episode_title}`;
                            }
                        } else if (np.episode_title) {
                            episodeDetails += np.episode_title;
                        }

                        nowPlayingDisplay.innerHTML = `
                            ${np.image_url ? `<img src="${np.image_url}" alt="Now Playing Image">` : ''}
                            <div id="now-playing-info">
                                <h3>${np.title}</h3>
                                ${episodeDetails ? `<p class="episode-details">${episodeDetails}</p>` : ''}
                                ${np.summary ? `<p class="summary">${np.summary}</p>` : ''}
                            </div>
                        `;
                        nowPlayingDisplay.classList.remove('hidden');
                        statusDisplay.style.display = 'none'; // Hide raw JSON when formatted is shown
                    } else {
                        nowPlayingDisplay.classList.add('hidden');
                        statusDisplay.style.display = 'block';
                        statusDisplay.innerText = "No 'Now Playing' information available (or not currently playing).\n\n" + statusDisplay.innerText;
                    }
                }
            } catch (error) {
                statusDisplay.innerText = `Error fetching status: ${error.message}\nEnsure the Channels App is running on ${selectedClientIp} and reachable.`;
                nowPlayingDisplay.classList.add('hidden');
                statusDisplay.style.display = 'block';
                showNotification(`Status fetch error for ${selectedClientIp}: ${error.message}`, true);
            }
        }

        async function loadChannels() {
            if (!selectedClientIp) {
                channelSelect.innerHTML = '<option value="">Select a Client First</option>';
                channelSelect.disabled = true;
                return;
            }

            channelSelect.innerHTML = '<option value="">Loading Channels...</option>';
            channelSelect.disabled = true;

            try {
                const response = await fetch(`/channels_list?device_ip=${selectedClientIp}`);
                const channels = await response.json();

                channelSelect.innerHTML = '<option value="">Select a Channel</option>';

                if (channels.status === 'error') {
                    showNotification(`Failed to load favorite channels: ${channels.message}`, true);
                    channelSelect.innerHTML = `<option value="">Error: ${channels.message}</option>`;
                } else if (channels.length === 0) {
                     channelSelect.innerHTML = '<option value="">No favorite channels found.</option>';
                } else {
                    channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.channel_number;
                        option.textContent = `${channel.channel_number} - ${channel.name}`;
                        channelSelect.appendChild(option);
                    });
                    channelSelect.disabled = false;
                    showNotification(`Favorite channels loaded for ${selectedClientIp}.`, false);
                }

            } catch (error) {
                showNotification(`Failed to fetch favorite channel list: ${error.message}`, true);
                channelSelect.innerHTML = '<option value="">Failed to load channels.</option>';
            }
        }

        function tuneToSelectedChannel() {
            const selectedChannel = channelSelect.value;
            if (selectedChannel) {
                sendCommand('play_channel', selectedChannel);
            }
        }

        async function loadMovies() {
            if (!selectedDvrServerIp) {
                moviesListDiv.innerHTML = '<p>Please select a DVR server to load movies.</p>';
                showNotification("Please select a DVR server to load movies.", true);
                return;
            }
            moviesListDiv.innerHTML = '';
            moviesListDiv.classList.add('loading');
            showNotification("Loading movies from DVR server...", false);

            try {
                const response = await fetch(`/dvr_movies?dvr_server_ip=${selectedDvrServerIp}`); // Pass DVR IP
                const result = await response.json();

                moviesListDiv.classList.remove('loading');

                if (result.status === 'error') {
                    moviesListDiv.innerHTML = `<p style="color: red;">Error: ${result.message}</p>`;
                    showNotification(`Failed to load movies: ${result.message}`, true);
                } else if (result.movies && result.movies.length > 0) {
                    result.movies.forEach(movie => {
                        const card = document.createElement('div');
                        card.className = 'movie-card';

                        const imageUrl = movie.image_url || 'https://placehold.co/120x90/333/eee?text=No+Image';
                        let movieDetails = '';
                        if (movie.release_year) {
                            movieDetails += `<p class="episode-details">Year: ${movie.release_year}</p>`;
                        }
                        if (movie.channel_call_sign) {
                            movieDetails += `<p class="episode-details">Channel: ${movie.channel_call_sign}</p>`;
                        }
                       
                        card.innerHTML = `
                            <div class="movie-card-image-container">
                                <img src="${imageUrl}" alt="${movie.title || 'Movie'}" onerror="this.onerror=null; this.src='https://placehold.co/120x90/333/eee?text=No+Image'; this.classList.add('error-img'); this.nextElementSibling.style.display='block';" />
                                ${!movie.image_url ? '<div class="no-image-text">No Image Available</div>' : ''}
                            </div>
                            <div class="movie-card-content">
                                <h3>${movie.title || 'Unknown Title'}</h3>
                                ${movieDetails}
                                ${movie.summary ? `<p class="summary">${movie.summary}</p>` : ''}
                                <div class="play-button-container">
                                    <button class="control-button play-button" onclick="playRecording('${movie.id}')">Play</button>
                                </div>
                            </div>
                        `;
                        moviesListDiv.appendChild(card);
                    });
                    showNotification(`Loaded ${result.movies.length} movies.`, false);
                } else {
                    moviesListDiv.innerHTML = '<p>No movies found on the DVR server.</p>';
                    showNotification("No movies found.", false);
                }
                checkArrowVisibility(moviesListDiv); // Check arrows after loading content
            } catch (error) {
                moviesListDiv.innerHTML = `<p style="color: red;">Error fetching movies: ${error.message}</p>`;
                moviesListDiv.classList.remove('loading');
                showNotification(`Error fetching movies: ${error.message}`, true);
                console.error("Error fetching movies:", error);
            }
        }

        async function loadShows() {
            if (!selectedDvrServerIp) {
                episodesListDiv.innerHTML = '<p>Please select a DVR server to load TV shows.</p>';
                showNotification("Please select a DVR server to load TV shows.", true);
                return;
            }
            episodesListDiv.innerHTML = '';
            episodesListDiv.classList.add('loading');
            showNotification("Loading TV show episodes from DVR server...", false);

            try {
                const response = await fetch(`/dvr_shows?dvr_server_ip=${selectedDvrServerIp}`); // Pass DVR IP
                const result = await response.json();

                episodesListDiv.classList.remove('loading');

                if (result.status === 'error') {
                    episodesListDiv.innerHTML = `<p style="color: red;">Error: ${result.message}</p>`;
                    showNotification(`Failed to load TV show episodes: ${result.message}`, true);
                } else if (result.episodes && result.episodes.length > 0) {
                    result.episodes.forEach(episode => {
                        const card = document.createElement('div');
                        card.className = 'episode-card';

                        const imageUrl = episode.image_url || 'https://placehold.co/120x90/333/eee?text=No+Image';
                        let episodeDetails = '';
                        if (episode.season_number && episode.episode_number) {
                            episodeDetails += `<p class="episode-details">S${episode.season_number} E${episode.episode_number}`;
                            if (episode.episode_title) {
                                episodeDetails += `: ${episode.episode_title}</p>`;
                            } else {
                                episodeDetails += `</p>`;
                            }
                        } else if (episode.episode_title) {
                            episodeDetails += `<p class="episode-details">${episode.episode_title}</p>`;
                        }
                        if (episode.channel_call_sign) {
                            episodeDetails += `<p class="episode-details">Channel: ${episode.channel_call_sign}</p>`;
                        }
                        if (episode.air_date) {
                            const date = new Date(episode.air_date * 1000);
                            episodeDetails += `<p class="episode-details">Aired: ${date.toLocaleDateString()}</p>`;
                        }


                        card.innerHTML = `
                            <div class="episode-card-image-container">
                                <img src="${imageUrl}" alt="${episode.show_title || 'Show'}" onerror="this.onerror=null; this.src='https://placehold.co/120x90/333/eee?text=No+Image'; this.classList.add('error-img'); this.nextElementSibling.style.display='block';" />
                                ${!episode.image_url ? '<div class="no-image-text">No Image Available</div>' : ''}
                            </div>
                            <div class="episode-card-content">
                                <h3>${episode.show_title || 'Unknown Show'}</h3>
                                ${episodeDetails}
                                ${episode.summary ? `<p class="summary">${episode.summary}</p>` : ''}
                                <div class="play-button-container">
                                    <button class="control-button play-button" onclick="playRecording('${episode.id}')">Play Episode</button>
                                </div>
                            </div>
                        `;
                        episodesListDiv.appendChild(card);
                    });
                    showNotification(`Loaded ${result.episodes.length} TV show episodes.`, false);
                } else {
                    episodesListDiv.innerHTML = '<p>No TV show episodes found on the DVR server.</p>';
                    showNotification("No TV show episodes found.", false);
                }
                checkArrowVisibility(episodesListDiv); // Check arrows after loading content
            } catch (error) {
                episodesListDiv.innerHTML = `<p style="color: red;">Error fetching TV shows: ${error.message}</p>`;
                episodesListDiv.classList.remove('loading');
                showNotification(`Error fetching TV shows: ${error.message}`, true);
                console.error("Error fetching TV shows:", error);
            }
        }

        async function playRecording(recordingId) {
            if (!selectedClientIp) {
                showNotification("Please select a Channels App client to play the content on.", true);
                return;
            }
            showNotification(`Attempting to play recording ${recordingId} on ${selectedClientIp}...`, false);
            const status = await sendCommand('play_recording', null, recordingId); // Changed action to 'play_recording'
            if (status === 'success') {
                showNotification(`Playing recording ${recordingId}.`, false);
            } else {
                showNotification(`Failed to play recording ${recordingId}.`, true);
            }
        }

        // Modified toggleSection to use carousel-wrapper IDs
        function toggleSection(wrapperId, button) {
            const wrapperDiv = document.getElementById(wrapperId);
            const currentDisplay = window.getComputedStyle(wrapperDiv).display;

            if (currentDisplay === 'none') {
                wrapperDiv.style.display = 'block'; // Revert to block to contain flex carousel
                button.textContent = 'Hide Content';
                // Re-check arrow visibility if content was hidden and now shown
                const carouselDiv = wrapperDiv.querySelector('.scroll-arrow').previousElementSibling; // Get the actual list div
                checkArrowVisibility(carouselDiv);
            } else {
                wrapperDiv.style.display = 'none';
                button.textContent = 'Show Content';
            }
        }

        // Carousel Navigation JavaScript
        function scrollCarousel(carouselElement, direction) {
            const scrollAmount = 175; // Adjust scroll amount as needed
            carouselElement.scrollBy({
                left: direction * scrollAmount,
                behavior: 'smooth'
            });
        }

        function startAutoScroll(carouselElement, direction) {
            // Clear any existing interval to prevent multiple intervals running
            stopAutoScroll();
            // Start a new interval
            autoScrollInterval = setInterval(() => {
                scrollCarousel(carouselElement, direction);
            }, 70); // Scroll every 50ms for a smooth effect
        }

        function stopAutoScroll() {
            clearInterval(autoScrollInterval);
            autoScrollInterval = null;
        }

        function checkArrowVisibility(carouselElement) {
            const wrapper = carouselElement.closest('.carousel-wrapper');
            if (!wrapper) return; // Exit if not inside a wrapper

            const leftArrow = wrapper.querySelector('.scroll-arrow.left');
            const rightArrow = wrapper.querySelector('.scroll-arrow.right');

            if (!leftArrow || !rightArrow) return; // Ensure arrows exist

            const { scrollLeft, scrollWidth, clientWidth } = carouselElement;

            // Show/hide left arrow
            if (scrollLeft > 0) {
                leftArrow.classList.remove('hidden');
            } else {
                leftArrow.classList.add('hidden');
            }

            // Show/hide right arrow
            // Give a small buffer (e.g., 1px) for floating point inaccuracies
            if (scrollLeft + clientWidth < scrollWidth - 1) {
                rightArrow.classList.remove('hidden');
            } else {
                rightArrow.classList.add('hidden');
            }
        }

        function setupCarouselNavigation() {
            const movieCarousel = document.getElementById('movies-list');
            const episodeCarousel = document.getElementById('episodes-list');

            if (movieCarousel) {
                movieCarousel.addEventListener('scroll', () => checkArrowVisibility(movieCarousel));
                // Initial check for movies
                checkArrowVisibility(movieCarousel);
            }
            if (episodeCarousel) {
                episodeCarousel.addEventListener('scroll', () => checkArrowVisibility(episodeCarousel));
                // Initial check for episodes
                checkArrowVisibility(episodeCarousel);
            }

            // Re-check on window resize
            window.addEventListener('resize', () => {
                if (movieCarousel) checkArrowVisibility(movieCarousel);
                if (episodeCarousel) checkArrowVisibility(episodeCarousel);
            });
        }

    </script>
</body>
</html>